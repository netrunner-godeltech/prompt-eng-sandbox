<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Prompt Engineering Sandbox (WebSocket)</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: #f4f6fb;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 2em 2em 1em 2em;
    }
    h2 {
      text-align: center;
      color: #2d3a4a;
      margin-bottom: 1.5em;
    }
    #output {
      background: #f7f9fc;
      border-radius: 12px;
      border: 1px solid #e0e6ed;
      padding: 1em;
      min-height: 180px;
      margin-bottom: 1.5em;
      max-height: 400px;
      overflow-y: auto;
      font-size: 1.05em;
    }
    .msg {
      display: flex;
      margin-bottom: 0.7em;
    }
    .user-bubble, .assistant-bubble {
      padding: 0.7em 1.2em;
      border-radius: 18px;
      max-width: 80%;
      word-break: break-word;
      font-size: 1em;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .user-bubble {
      background: #e3f0ff;
      color: #1565c0;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .assistant-bubble {
      background: #eafbe7;
      color: #388e3c;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    .sender {
      font-size: 0.9em;
      font-weight: bold;
      margin-bottom: 0.2em;
      opacity: 0.7;
    }
    .input-row {
      display: flex;
      gap: 0.5em;
      margin-top: 1em;
    }
    #prompt {
      flex: 1;
      padding: 0.7em 1em;
      border-radius: 8px;
      border: 1px solid #bfc9d9;
      font-size: 1em;
      outline: none;
      transition: border 0.2s;
    }
    #prompt:focus {
      border: 1.5px solid #1565c0;
    }
    #send {
      padding: 0.7em 1.5em;
      border-radius: 8px;
      border: none;
      background: #1565c0;
      color: #fff;
      font-weight: bold;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    #send:disabled {
      background: #bfc9d9;
      cursor: not-allowed;
    }
    @media (max-width: 700px) {
      .container { padding: 1em 0.5em 0.5em 0.5em; }
      #output { font-size: 0.97em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Prompt Engineering Sandbox</h2>
    <div id="output"></div>
    <div class="input-row">
      <input type="text" id="prompt" placeholder="Wpisz prompt..." autocomplete="off" />
      <button id="send">Wyślij</button>
    </div>
  </div>
  <script>
    let ws;
    let output = document.getElementById('output');
    let sendBtn = document.getElementById('send');
    let promptBox = document.getElementById('prompt');

    // Historia rozmowy
    let messages = [
      { role: 'system', content: 'You are just artifical friend which should now almost everything about the world.' }
    ];

    let currentAssistantMessage = '';
    let loading = false;

    function renderChat() {
      output.innerHTML = '';
      for (const msg of messages) {
        if (msg.role === 'user') {
          output.innerHTML += `
            <div class="msg" style="justify-content: flex-end;">
              <div>
                <div class="sender">Ty</div>
                <div class="user-bubble">${msg.content}</div>
              </div>
            </div>`;
        } else if (msg.role === 'assistant') {
          output.innerHTML += `
            <div class="msg" style="justify-content: flex-start;">
              <div>
                <div class="sender">AI</div>
                <div class="assistant-bubble">${msg.content}</div>
              </div>
            </div>`;
        }
      }
      // Jeśli trwa generowanie odpowiedzi, pokaż ją na bieżąco
      if (loading && !currentAssistantMessage) {
        output.innerHTML += `
          <div class="msg" style="justify-content: flex-start;">
            <div>
              <div class="sender">AI</div>
              <div class="assistant-bubble"><em>Thinking...</em></div>
            </div>
          </div>`;
      }
      if (currentAssistantMessage) {
        output.innerHTML += `
          <div class="msg" style="justify-content: flex-start;">
            <div>
              <div class="sender">AI</div>
              <div class="assistant-bubble">${currentAssistantMessage}</div>
            </div>
          </div>`;
      }
      output.scrollTop = output.scrollHeight;
    }

    function connect() {
      ws = new WebSocket('ws://localhost:8081');
      ws.onopen = () => {
        // output.textContent = '[Połączono z serwerem]\n';
      };
      ws.onmessage = (event) => {
        if (event.data === '[END]') {
          if (currentAssistantMessage.trim()) {
            messages.push({ role: 'assistant', content: currentAssistantMessage });
          }
          currentAssistantMessage = '';
          loading = false;
          renderChat();
        } else if (event.data === '[ERROR]') {
          output.innerHTML += `<div class="msg"><span style="color:red;">[Błąd serwera]</span></div>`;
          loading = false;
        } else {
          // Pierwszy fragment odpowiedzi usuwa napis "Thinking..."
          if (loading) loading = false;
          currentAssistantMessage += event.data;
          renderChat();
        }
      };
      ws.onclose = () => {
        output.innerHTML += `<div class="msg"><span style="color:#888;">[Połączenie zamknięte]</span></div>`;
      };
    }

    sendBtn.onclick = () => {
      const userPrompt = promptBox.value.trim();
      if (!userPrompt) return;
      if (!ws || ws.readyState !== 1) connect();
      // Dodaj wiadomość użytkownika do historii
      messages.push({ role: 'user', content: userPrompt });
      // Wyślij całą historię jako JSON
      ws.send(JSON.stringify(messages));
      // Wyczyść textbox
      promptBox.value = '';
      // Resetuj tymczasową odpowiedź asystenta
      currentAssistantMessage = '';
      loading = true;
      renderChat();
    };

    promptBox.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') sendBtn.onclick();
    });

    connect();
    renderChat();
  </script>
</body>
</html>